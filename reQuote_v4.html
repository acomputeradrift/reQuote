<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reQuote_v4</title>
</head>
<body>
    <h1>Welcome to reQuote v_4</h1>

    <!-- Authentication Section -->
    <div id="auth-section">

        <!-- Updated Signup Form -->
        <h2>Sign Up</h2>
        <form id="signup-form">
            <input type="text" id="signup-email" placeholder="Email" required>
            <input type="password" id="signup-password" placeholder="Password" required>
            <button type="submit">Sign Up</button>
        </form>

        <!-- Updated Login Form -->
        <h2>Login</h2>
        <form id="login-form">
            <input type="text" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>

    </div>

    <!-- Quotes Section -->
    <div id="quotes-section" style="display: none;">
        <h2>Quotes</h2>
        <form id="add-quote-form">
            <input type="text" id="quote-content" placeholder="Quote" required>
            <input type="text" id="quote-author" placeholder="Author" required>
            <button type="submit">Add Quote</button>
        </form>
        <ul id="quotes-list"></ul>
    </div>

    <script>
        const authSection = document.getElementById('auth-section');
        const quotesSection = document.getElementById('quotes-section');
        const signupForm = document.getElementById('signup-form');
        const loginForm = document.getElementById('login-form');
        const addQuoteForm = document.getElementById('add-quote-form');
        const quotesList = document.getElementById('quotes-list');

        let token = null;

addQuoteForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const content = document.getElementById('quote-content').value;
    const author = document.getElementById('quote-author').value;

    try {
        const response = await fetch('/quotes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`, // Include the token
            },
            body: JSON.stringify({ content, author }),
        });

        if (response.ok) {
            alert('Quote added successfully!');
            addQuoteForm.reset(); // Clear the form
            loadQuotes(); // Reload the quotes list to show the new quote
        } else {
            const data = await response.json();
            alert(`Failed to add quote: ${data.message}`);
        }
    } catch (error) {
        console.error('Error adding quote (frontend):', error);
        alert('Failed to add quote (frontend).');
    }
});

//Drag and drop abilty

async function loadQuotes() {
    try {
        const response = await fetch('/quotes', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
        });

        if (response.ok) {
            const quotes = await response.json();
            
            // Sort quotes by the order attribute before rendering
            quotes.sort((a, b) => a.order - b.order);
            console.log('Quotes retrieved from backend:', quotes);
            quotesList.innerHTML = ''; // Clear the list before updating

            quotes.forEach((quote) => {
                const li = document.createElement('li');
                li.textContent = `"${quote.content}" - ${quote.author} [Order: ${quote.order}]`;
                li.setAttribute('draggable', true); // Make the list item draggable
                li.dataset.id = quote._id; // Store the quote ID for reference

                // Drag-and-Drop Events
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('drop', handleDrop);

                // Create a delete button
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.style.marginLeft = '10px';
                deleteButton.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this quote?')) {
                        await deleteQuote(quote._id); // Call the delete function
                        loadQuotes(); // Refresh the quotes list
                    }
                });

                li.appendChild(deleteButton); // Add the button to the list item
                quotesList.appendChild(li);
            });
        } else {
            const data = await response.json();
            alert(`Failed to load quotes: ${data.message}`);
        }
    } catch (error) {
        console.error('Error loading quotes (frontend):', error);
        alert('Failed to load quotes (frontend).');
    }
}

// Drag-and-Drop Handlers with Persistence
let draggedItem = null;

function handleDragStart(event) {
    draggedItem = event.target; // Store the dragged element
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', event.target.dataset.id); // Pass the ID
    event.target.style.opacity = '0.5'; // Visual feedback
}

function handleDragOver(event) {
    event.preventDefault(); // Allow dropping
    event.dataTransfer.dropEffect = 'move';
}

async function handleDrop(event) {
    event.preventDefault();
    const targetItem = event.target.closest('li'); // Get the drop target
    if (draggedItem && targetItem && draggedItem !== targetItem) {
        // Swap the positions visually
        quotesList.insertBefore(draggedItem, targetItem.nextSibling);

        // Save the new order
        await saveOrder();
         // Refresh the quotes list to reflect the updated order
         await loadQuotes();
    }
    draggedItem.style.opacity = '1'; // Reset the dragged item's opacity
    draggedItem = null;
}

//Latest Save Order Function

async function saveOrder() {
    try {
        const newOrder = Array.from(quotesList.children).map((li, index) => ({
            id: li.dataset.id, // Quote ID from the DOM
            order: index, // New order based on position
        }));

        console.log('Saving order to backend:', newOrder); // Debug log

        const response = await fetch('/quotes/reorder', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newOrder), // Send the updated order
        });

        if (!response.ok) {
            const data = await response.json();
            alert(`Failed to save order: ${data.message}`);
        } else {
            console.log('Order saved successfully');
        }
    } catch (error) {
        console.error('Error saving order (frontend):', error);
        alert('Failed to save order (frontend).');
    }
}


// // Save Order Function
// async function saveOrder() {
//     console.log('Saving order:', newOrder);
//     const newOrder = Array.from(quotesList.children).map((li, index) => ({
//         id: li.dataset.id,
//         order: index,
//     }));

//     try {
//         const response = await fetch('/quotes/reorder', {
//             method: 'POST',
//             headers: {
//                 'Authorization': `Bearer ${token}`,
//                 'Content-Type': 'application/json',
//             },
//             body: JSON.stringify(newOrder),
//         });

//         if (!response.ok) {
//             const data = await response.json();
//             alert(`Failed to save order: ${data.message}`);
//         }
//     } catch (error) {
//         console.error('Error saving order (frontend):', error);
//         alert('Failed to save order (frontend).');
//     }
// }



//Updated loadQuote function

// async function loadQuotes() {
//     try {
//         const response = await fetch('/quotes', {
//             method: 'GET',
//             headers: {
//                 'Authorization': `Bearer ${token}`,
//             },
//         });

//         if (response.ok) {
//             const quotes = await response.json();
//             quotesList.innerHTML = ''; // Clear the list before updating
//             quotes.forEach((quote) => {
//                 const li = document.createElement('li');
//                 li.textContent = `"${quote.content}" - ${quote.author} [${quote.tag}]`;

//                 // Create a delete button
//                 const deleteButton = document.createElement('button');
//                 deleteButton.textContent = 'Delete';
//                 deleteButton.style.marginLeft = '10px';
//                 deleteButton.addEventListener('click', async () => {
//                     console.log('Delete button clicked for:', quote._id); // Ensure the event fires
//                     if (confirm('Are you sure you want to delete this quote?')) {
//                         await deleteQuote(quote._id); // Call the delete function
//                         loadQuotes(); // Refresh the quotes list
//                     }
//                 });

//                 li.appendChild(deleteButton); // Add the button to the list item
//                 quotesList.appendChild(li);
//             });
//         } else {
//             const data = await response.json();
//             alert(`Failed to load quotes: ${data.message}`);
//         }
//     } catch (error) {
//         console.error('Error loading quotes (frontend):', error);
//         alert('Failed to load quotes (frontend).');
//     }
// }

    //Delete Quote
    async function deleteQuote(quoteId) {
        console.log('Attempting DELETE for:', `/quotes/${quoteId}`);
    try {
        const response = await fetch(`/quotes/${quoteId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
        });

        if (response.ok) {
            alert('Quote deleted successfully');
        } else {
            const data = await response.json();
            alert(`Failed to delete quote: ${data.message}`);
        }
    } catch (error) {
        console.error('Error deleting quote:', error);
        alert('Failed to delete quote (frontend).');
    }
}

        // Updated Signup Logic
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                const response = await fetch('/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    alert('Sign-up successful! Please log in.');
                    signupForm.reset();
                } else {
                    const data = await response.json();
                    alert(`Sign-up failed: ${data.message}`);
                }
            } catch (error) {
                console.error("Error during sign-up:", error);
                alert('Sign-up failed.');
            }
        });

        // Updated Login Logic
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    alert(`Login successful! Welcome ${data.email}!`);
                    authSection.style.display = 'none';
                    quotesSection.style.display = 'block';
                    loadQuotes();
                } else {
                    const data = await response.json();
                    alert(`Login failed: ${data.message}`);
                }
            } catch (error) {
                console.error("Error during login:", error);
                alert('Login failed.');
            }
        });
    </script>
</body>
</html>
